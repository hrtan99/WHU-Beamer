%========== 元信息定义 ==========%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{WHU-Beamer}[2022/04/26 Wuhan University Beamer Theme]

%========== 预定义部分 ==========%
\RequirePackage{ctex} % 中文支持
\RequirePackage{hyperref}
\RequirePackage[T1]{fontenc}

% other packages
\RequirePackage{latexsym}
\RequirePackage{amsmath,amsfonts,amssymb} % 数学公式
\RequirePackage{xcolor} % 代码着色

\RequirePackage{algorithm,algorithmic}
\RequirePackage{multicol,multirow} 
\RequirePackage{booktabs} 
\RequirePackage{calligra} 
\RequirePackage{graphicx} % 图片支持
\RequirePackage{pstricks} 
\RequirePackage{listings} % 代码包
\RequirePackage{stackengine}
\RequirePackage{tikz} % tikz: 绘制图像.
\RequirePackage{tcolorbox} % tcolorbox: 绘制彩色文本框.
\RequirePackage{caption} % 图片插入标题
\RequirePackage{subcaption} % 子图片插入标题
\RequirePackage[backend=biber,style=numeric-comp,sorting=none]{biblatex} % 参考文献

% 添加引用路径
\addbibresource{./ref/ref.bib}

% 设置图片的标题字体
\captionsetup{font=scriptsize,labelfont=scriptsize}

% tcolorbox使用对应的库
\tcbuselibrary{theorems, skins, breakable, xparse, listings}
\tcbset{listing engine=listings}

% tikz引入shapes
\usetikzlibrary{shapes}


% 定义执行命令. 修改自 sjtubeamer.
\def\EqualOptionsBeamer{%
  \relax\fi\ifEqualOptionsBeamer%
}
\def\ifEqualOptionsBeamer#1#2{%
% #1: Option - Key.
% #2: Option - Value.
  \newif\ifoption@tmp%
  \edef\optionkey@tmp{%
    \csname beamer@whu@#1\endcsname%
  }%
  \edef\optionvalue@tmp{#2}%
  \ifx\optionkey@tmp\optionvalue@tmp\option@tmptrue%
  \else\option@tmpfalse\fi%
  \ifoption@tmp%
}

% 改变引用字体大小
\renewcommand*{\bibfont}{\scriptsize}

% 重写上标引用命令。请勿随意改动括号缩进。
\DeclareCiteCommand{\supercite}[\mkbibsuperscript]
  {\bibopenbracket
    \usebibmacro{cite:init}%
    \let\multicitedelim=\supercitedelim
    \iffieldundef{prenote}{}
      {\BibliographyWarning{Ignoring prenote argument}}%
    \iffieldundef{postnote}{}
      {\BibliographyWarning{Ignoring postnote argument}}}
  {\usebibmacro{citeindex}\usebibmacro{cite:comp}}
  {}
  {\usebibmacro{cite:dump}\bibclosebracket}

% 代码块颜色
\definecolor{deepblue}{rgb}{0,0,0.5}
\definecolor{deepred}{rgb}{0.6,0,0}
\definecolor{deepgreen}{rgb}{0,0.5,0}
\definecolor{halfgray}{gray}{0.55}

% 注: 常用的颜色模式有 RGB 与 CMYK, 对应 LaTeX 中 rgb(0-1小数制, x/255), RGB(原始数值), cmyk(0-1小数制, x/100).
% 以下定义一些颜色及其渐变色，包含来自各学校的颜色定义
% ----------------

% COLOR:: 武大青色 - whucyan
\definecolor{whucyan}{cmyk}{0.5,0,0.15,0}
\colorlet{whucyan10}   {whucyan!10!white}
\colorlet{whucyan20}   {whucyan!20!white}
\colorlet{whucyan30}   {whucyan!30!white}
\colorlet{whucyan40}   {whucyan!40!white}
\colorlet{whucyan50}   {whucyan!50!white}
\colorlet{whucyan60}   {whucyan!60!white}
\colorlet{whucyan70}   {whucyan!70!white}
\colorlet{whucyan80}   {whucyan!80!white}
\colorlet{whucyan90}   {whucyan!90!white}

% COLOR:: 清华紫色 - thupurple
\xdefinecolor{thupurple}{rgb}{0.455,0.204,0.506} 
\colorlet{thupurple10}   {thupurple!10!white}
\colorlet{thupurple20}   {thupurple!20!white}
\colorlet{thupurple30}   {thupurple!30!white}
\colorlet{thupurple40}   {thupurple!40!white}
\colorlet{thupurple50}   {thupurple!50!white}
\colorlet{thupurple60}   {thupurple!60!white}
\colorlet{thupurple70}   {thupurple!70!white}
\colorlet{thupurple80}   {thupurple!80!white}
\colorlet{thupurple90}   {thupurple!90!white}

% COLOR:: 川大锦绣红 - scured    - CMYK(12,92,95,20).
\definecolor{scured}   {cmyk}{0.12,0.92,0.95,0.20}
\colorlet{scured10}   {scured!10!white}
\colorlet{scured20}   {scured!20!white}
\colorlet{scured30}   {scured!30!white}
\colorlet{scured40}   {scured!40!white}
\colorlet{scured50}   {scured!50!white}
\colorlet{scured60}   {scured!60!white}
\colorlet{scured70}   {scured!70!white}
\colorlet{scured80}   {scured!80!white}
\colorlet{scured90}   {scured!90!white}

% COLOR:: 川大优雅灰 - scugrey   - CMYK(47,37,37,20).
\definecolor{scugrey}  {cmyk}{0.47,0.37,0.37,0.00}
\colorlet{scugrey10}  {scugrey!10!white}
\colorlet{scugrey20}  {scugrey!20!white}
\colorlet{scugrey30}  {scugrey!30!white}
\colorlet{scugrey40}  {scugrey!40!white}
\colorlet{scugrey50}  {scugrey!50!white}
\colorlet{scugrey60}  {scugrey!60!white}
\colorlet{scugrey70}  {scugrey!70!white}
\colorlet{scugrey80}  {scugrey!80!white}
\colorlet{scugrey90}  {scugrey!90!white}

% COLOR:: 川大宝石蓝 - scublue   - CMYK(100,60,0,15).
\definecolor{scublue}  {cmyk}{1.00,0.60,0.00,0.15}
\colorlet{scublue10}  {scublue!10!white}
\colorlet{scublue20}  {scublue!20!white}
\colorlet{scublue30}  {scublue!30!white}
\colorlet{scublue40}  {scublue!40!white}
\colorlet{scublue50}  {scublue!50!white}
\colorlet{scublue60}  {scublue!60!white}
\colorlet{scublue70}  {scublue!70!white}
\colorlet{scublue80}  {scublue!80!white}
\colorlet{scublue90}  {scublue!90!white}

% COLOR:: 川大荷叶绿 - scugreen  - CMYK(100,0,90,15).
\definecolor{scugreen} {cmyk}{1.00,0.00,0.90,0.15}
\colorlet{scugreen10} {scugreen!10!white}
\colorlet{scugreen20} {scugreen!20!white}
\colorlet{scugreen30} {scugreen!30!white}
\colorlet{scugreen40} {scugreen!40!white}
\colorlet{scugreen50} {scugreen!50!white}
\colorlet{scugreen60} {scugreen!60!white}
\colorlet{scugreen70} {scugreen!70!white}
\colorlet{scugreen80} {scugreen!80!white}
\colorlet{scugreen90} {scugreen!90!white}

% COLOR:: 川大银杏黄 - scuyellow - CMYK(0,40,100,15).
\definecolor{scuyellow}{cmyk}{0.00,0.40,1.00,0.15}
\colorlet{scuyellow10}{scuyellow!10!white}
\colorlet{scuyellow20}{scuyellow!20!white}
\colorlet{scuyellow30}{scuyellow!30!white}
\colorlet{scuyellow40}{scuyellow!40!white}
\colorlet{scuyellow50}{scuyellow!50!white}
\colorlet{scuyellow60}{scuyellow!60!white}
\colorlet{scuyellow70}{scuyellow!70!white}
\colorlet{scuyellow80}{scuyellow!80!white}
\colorlet{scuyellow90}{scuyellow!90!white}
% ----------------

% 在此处设置主题颜色
\colorlet{ThemeColor}{whucyan} 
\colorlet{ThemeColor10}{ThemeColor!10!black}
\colorlet{ThemeColor20}{ThemeColor!20!black}
\colorlet{ThemeColor30}{ThemeColor!30!black}
\colorlet{ThemeColor40}{ThemeColor!40!black}
\colorlet{ThemeColor50}{ThemeColor!50!black}
\colorlet{ThemeColor60}{ThemeColor!60!black}
\colorlet{ThemeColor70}{ThemeColor!70!black}
\colorlet{ThemeColor80}{ThemeColor!80!black}
\colorlet{ThemeColor90}{ThemeColor!90!black}


% 设置页面间距
% \setbeamersize {
%   text margin left=1.5cm,
%   text margin right=1.5cm
% }

% 用于判断是否目录分栏
\newif\ifbeamer@whu@contentmuticols

% KEY:: BlockDisplay.
% VALUE:: colorful | followtheme | allgrey.
\DeclareOptionBeamer{BlockDisplay}{\def\beamer@whu@BlockDisplay{#1}}
% KEY:: LanguageMode.
% VALUE:: cn | en.
\DeclareOptionBeamer{LanguageMode}{\def\beamer@whu@LanguageMode{#1}}
% KEY:: ColorDisplay.
% VALUE:: JXred | BSblue.
\DeclareOptionBeamer{ColorDisplay}{\def\beamer@whu@ColorDisplay{#1}}
% KEY:: AspectRatio [PASSTO:: beamercolorthemescu.sty].
% VALUE:: 1610 | 169.
% 注：1610表示16:10的比例；169表示16:9的比例。
\DeclareOptionBeamer{AspectRatio}{\def\beamer@whu@AspectRatio{#1}}


% 展开后面的内容
\DeclareOptionBeamer{ContentMuticols}{\csname beamer@whu@contentmuticols#1\endcsname}

\ExecuteOptionsBeamer{%
  AspectRatio=1610,
  BlockDisplay=colorful,%
  ContentMuticols=true,%
  ColorDisplay=JXred,%
  LanguageMode=cn%
}

\ProcessOptionsBeamer



\mode<presentation>

% \newif\ifbeamer@secheader
% \beamer@secheaderfalse

%\DeclareOptionBeamer{secheader}{\beamer@secheadertrue}


% ----------------
% Background Layout
% ----------------
% 设置了主题背景选项 "background=true" & "background=false".
% 设置了页眉 logo.
% ----------------

\if\EqualOptionsBeamer{AspectRatio}{1610}%
  \def\beamer@whu@bg{./images/background_1610.png}
  \def\beamer@whu@bg@cover{./images/background_cover_1610.png}
  %\PackageWarningNoLine{beamerthemescu}{ratio set to 1610}
  \typeout{ratio set to 16:10.}
\else\if\EqualOptionsBeamer{AspectRatio}{169}%
  \def\beamer@whu@bg{./images/background_169.png}
  \def\beamer@whu@bg@cover{./images/background_cover_169.png}
  \typeout{ratio set to 16:9.}
\fi\fi

% 设置 "background.png" 为图片 "bg".
\pgfdeclareimage[width=\paperwidth]%
  {bg}{\beamer@whu@bg}
% 设置图片 "bg" 为背景图片.
\usebackgroundtemplate{\pgfuseimage{bg}}
% 设置 "background_cover.png" 为图片 "bgofsubsectoc".
\pgfdeclareimage[width=\paperwidth]%
  {bgofsubsectoc}{\beamer@whu@bg@cover}
% 设置 "background_cover.png" 为图片 "bgoftitle".
\pgfdeclareimage[width=\paperwidth]%
  {bgoftitle}{\beamer@whu@bg@cover}


% 设置 "whulogo.png" 为图片 "logo".
\pgfdeclareimage[width=6.25em]%
  {lg}{./images/whulogo.png}
% ----------------

% 设置定理环境
\def\themytheorem{\thesection.\arabic{mytheorem}}
\newcounter{TheoremCounter}[section] 
\newcounter{DefinitionCounter}[section] 
\newcounter{CorollaryCounter}[section] 
\newcounter{ExampleCounter}[section] 

\definecolor{thorem-yellow}{cmyk}{0,0.2,0.7,0,1.00}
\definecolor{thorem-blue}{cmyk}{0.80, 0.13, 0.14, 0.04, 1.00}
\definecolor{thorem-green}{cmyk}{0.4,0,0.4,0,1.00}

% 设置定理块样式
\tcbset{
  defstyle/.style={fonttitle=\bfseries\upshape, colback=thorem-yellow!5,colframe=thorem-yellow!80!black},
  theostyle/.style={fonttitle=\bfseries\upshape, colback=thorem-blue!5,colframe=thorem-blue!80!black},
  corstyle/.style={fonttitle=\bfseries\upshape, colback=thorem-green!5,colframe=thorem-green!80!black},
}

\newtcbtheorem[number within=section]{defn}{定义}{defstyle}{defn}
\newtcbtheorem[number within=section]{theo}{定理}{theostyle}{theo}
\newtcbtheorem[number within=section]{coro}{推论}{corstyle}{cor}
\newtcbtheorem[number within=section]{exm}{例}{corstyle}{eg}

% 注：定理环境在使用时需要两个必须参数 二者可以为空{} 
% 第一个参数是定理块的名称 第二个参数用于引用
% ref：https://tex.stackexchange.com/questions/628664/tcolorbox-theorem-environment-doesnt-show-first-character
% ----------------


% 设置代码高亮
% ref: https://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings
\lstdefinestyle{customc}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  frame=L,
  xleftmargin=\parindent,
  language=C,
  showstringspaces=false,
  basicstyle=\footnotesize\ttfamily,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{red!50!green!50!blue!50},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
}


\lstdefinestyle{customasm}{
  belowcaptionskip=1\baselineskip,
  frame=L,
  xleftmargin=\parindent,
  language=[x86masm]Assembler,
  basicstyle=\footnotesize\ttfamily,
  commentstyle=\itshape\color{purple!40!black},
}

\lstset{escapechar=@,style=customc,numbers=left,numberstyle=\tiny}

\newcommand{\includecode}[2][c]{\lstinputlisting[caption=#2, escapechar=, style=custom#1]{#2}<!---->}
% ----------------

% 定义目录输入命令。可以选择将目录分栏显示。
\def\inserttableofcontent{
  \ifbeamer@whu@contentmuticols%
    \begin{multicols}{2}
      \tableofcontents[]%
    \end{multicols}
  \else
    \tableofcontents[]
  \fi
}

% 添加封面及目录
\AtBeginDocument{%
  \begingroup%
    \kaishu
    \setbeamertemplate{background}{\pgfuseimage{bgoftitle}}%
  \endgroup%
}

% 小节前加目录.
\AtBeginSection[]{
  \begingroup%
    \setbeamertemplate{background}{\pgfuseimage{bgofsubsectoc}}%
    \begin{frame}
      \tableofcontents[sections=\value{section}]
    \end{frame}
  \endgroup%
}

% \AtBeginSubsection[]{%
%   \begingroup%
%     \setbeamertemplate{background}{\pgfuseimage{bg}}%
%     \begin{frame}{目录}
%       \inserttableofcontent
%     \end{frame}
%   \endgroup%
% }

\useoutertheme[footline=authorinstitute,subsection=false]{miniframes}

\makeatletter % [add curpage/total page at the bottom](http://tex.stackexchange.com/questions/100838/beamer-dresden-theme-miniframes-appeareance-and-frame-number-insertion)
\newcommand{\frameofframes}{/}
\newcommand{\setframeofframes}[1]{\renewcommand{\frameofframes}{#1}}


\makeatother

% ref：https://tex.stackexchange.com/questions/330817/beamer-template-customization-logo-headline-and-footline?newreg=c99281e2d52846a1abddc869f1cdc120


\def\beamer@linkspace#1{\vbox to7.5pt{}\kern#1}

%  使用 x / total 格式页码.
\def\insertfootlineframe{%
  \insertframenumber%
  \Acrobatmenu{GoToPage}{\beamer@linkspace{.275em}}%
  \,/\,\Acrobatmenu{GoToPage}{\beamer@linkspace{.275em}}%
  \inserttotalframenumber%
}

% footline
\makeatletter
\setbeamertemplate{footline}{%
  \leavevmode%
  \hbox{\begin{beamercolorbox}[wd=.5\paperwidth,ht=2.5ex,dp=1.125ex,leftskip=.3cm,rightskip=.3cm]{author in head/foot}%
    \usebeamerfont{author in head/foot}\insertshortdate \hfill \insertshortauthor
  \end{beamercolorbox}%
  \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.5ex,dp=1.125ex,leftskip=.3cm,rightskip=.3cm plus1fil]{title in head/foot}%
    % \usebeamerfont{title in head/foot}\insertshorttitle \hfill \insertframenumber \,/\, \inserttotalframenumber%
    \usebeamerfont{title in head/foot}\insertshorttitle \hfill \insertfootlineframe
  \end{beamercolorbox}}%
  \vskip0pt%
}
\makeatother

% Headline
\makeatletter
\setbeamertemplate{headline}{%
  \leavevmode%
  \@tempdimb=1.25ex%
  \ifnum\beamer@subsectionmax<\beamer@sectionmax%
    \multiply\@tempdimb by\beamer@sectionmax%
  \else%
    \multiply\@tempdimb by\beamer@subsectionmax%
  \fi%
  \ifdim\@tempdimb>0pt%
    \advance\@tempdimb by 1.825ex%
    \begin{beamercolorbox}[wd=.5\paperwidth,ht=\@tempdimb]{section in head/foot}%
      \vspace*{1mm}\hspace*{-2mm}%
      \insertsectionnavigationhorizontal{.5\paperwidth}{}{\hskip0pt plus1filll}
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=.4\paperwidth,ht=\@tempdimb]{subsection in head/foot}%
      % \vbox to\@tempdimb{
      %   \vfil
      %   \insertsubsectionnavigation
      %   {.5\paperwidth}
      %   \vfil
      % }%
      \vbox to\@tempdimb{
        \vfill
        \insertsubsectionnavigationhorizontal{.4\paperwidth}{}{\hskip0pt plus1filll}
        \vfill
      }%
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=.1\paperwidth,ht=\@tempdimb]{subsection in head/foot}%
      \hspace*{-5ex}
      \includegraphics[height=\@tempdimb]{images/whulogo.png}
    \end{beamercolorbox}%    
  \fi%
}
\makeatother

% 设置箭头样式
% ref：https://tex.stackexchange.com/questions/398326/custom-horizontal-navigation-bar-for-beamer
\setbeamertemplate{section in head/foot}{%
    \if\insertsectionheadnumber1
        \tikz\node[draw=ThemeColor,fill=ThemeColor,shape=signal,very thick,text=white]{\insertsectionhead\hskip.3cm};
    \else
        \tikz\node[draw=ThemeColor,fill=ThemeColor,shape=signal,signal from=west, signal to=east,very thick,text=white]     {\insertsectionhead\hskip.3cm};
  \fi
}

\setbeamertemplate{section in head/foot shaded}{%
    \if\insertsectionheadnumber1
        \tikz\node[draw=ThemeColor,fill=white,shape=signal,very thick,text=ThemeColor]{\insertsectionhead\hskip.3cm};
    \else
        \tikz\node[draw=ThemeColor,fill=white,shape=signal,signal from=west, signal to=east,very thick,text=ThemeColor]     {\insertsectionhead\hskip.3cm};
  \fi
}

%--------------
\useinnertheme{circles}

%\useoutertheme{default}
%\useinnertheme[shadow=true]{rounded}



% 设置一下相关字体大小
\setbeamerfont{footnote}{size=\tiny}
\setbeamerfont{author}{size=\large}
\setbeamerfont{institute}{size=\footnotesize}
\setbeamerfont{date}{size=\footnotesize}
\setbeamerfont{frametitle}{size=\small}
\setbeamerfont{section in toc}{size=\large}
\setbeamerfont{subsection in toc}{size=\small}


% hyperref设置文中引用的颜色
\hypersetup{
    colorlinks,
    citecolor=ThemeColor50,
    allcolors=ThemeColor80
}

% 设置各种元素的颜色
\setbeamercolor{footline}{bg=ThemeColor}
\setbeamercolor{frametitle}{bg=ThemeColor,fg=white}
\setbeamercolor{title}{bg=ThemeColor}
\setbeamercolor{subsection in toc}{fg=ThemeColor50}
\setbeamercolor{navigation symbols}{bg=ThemeColor50,fg=ThemeColor50}
\setbeamercolor{bibliography item}{fg=ThemeColor50}
\setbeamercolor{bibliography entry author}{fg=scugrey}
\setbeamercolor{bibliography entry title}{fg=ThemeColor80} 
\setbeamercolor{bibliography entry location}{fg=scugrey} 
\setbeamercolor{bibliography entry note}{fg=scugrey}  



% 将引用参考文献的图片改为数字
\setbeamertemplate{bibliography item}[text]
\setbeamertemplate{caption}[numbered]

% 小节目录样式 %

% \defbeamertemplate{subsection in toc}{bullets}{%
%   \leavevmode
%   \leftskip=1.5em
%   \parbox[t]{1em}{\textbullet\hfill}%
%   \parbox[t]{\dimexpr\textwidth\relax}{\inserttocsubsection}
%   \par
% }
%\setbeamertemplate{subsection in toc}[bullets]

\setbeamertemplate{subsection in toc}{
  \leavevmode
  \leftskip=3.2em
  \rlap{
    \hskip-2em
    \inserttocsectionnumber.
    \inserttocsubsectionnumber
  }
  \inserttocsubsection\par
}
%-----------------------





% 设置structure的四种调色板颜色
\setbeamercolor{palette primary}{use=structure,fg=white,bg=structure.fg}
\setbeamercolor{palette secondary}{use=structure,fg=white,bg=structure.fg!90!black}
\setbeamercolor{palette tertiary}{use=structure,fg=white,bg=structure.fg!80!black}
\setbeamercolor{palette quaternary}{fg=white,bg=structure.fg!80!black}
%\setbeamercolor*{sidebar}{use=structure,bg=structure.fg}
\setbeamercolor{titlelike}{parent=palette primary}

\setbeamercolor{block title}{bg=ThemeColor,fg=white}
\setbeamercolor*{block title example}{use={normal text,example text},bg=white,fg=ThemeColor}
\setbeamercolor{fine separation line}{}
\setbeamercolor{item projected}{fg=white}

\setbeamercolor{separation line}{}
\setbeamercolor{structure}{fg=ThemeColor}



\mode
<all>
